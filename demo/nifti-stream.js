"use strict";var niftiStream=(()=>{var tt=Object.defineProperty;var ht=Object.getOwnPropertyDescriptor;var ft=Object.getOwnPropertyNames;var dt=Object.prototype.hasOwnProperty;var rt=c=>{throw TypeError(c)};var ct=(c,e)=>{for(var t in e)tt(c,t,{get:e[t],enumerable:!0})},ut=(c,e,t,l)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ft(e))!dt.call(c,s)&&s!==t&&tt(c,s,{get:()=>e[s],enumerable:!(l=ht(e,s))||l.enumerable});return c};var mt=c=>ut(tt({},"__esModule",{value:!0}),c);var at=(c,e,t)=>e.has(c)||rt("Cannot "+t);var b=(c,e,t)=>(at(c,e,"read from private field"),t?t.call(c):e.get(c)),k=(c,e,t)=>e.has(c)?rt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(c):e.set(c,t),G=(c,e,t,l)=>(at(c,e,"write to private field"),l?l.call(c,t):e.set(c,t),t);var pt={};ct(pt,{Nifti1Header:()=>E,Nifti2Header:()=>Y,NiftiExtension:()=>D,NiftiIOError:()=>S,NiftiStream:()=>st,NiftiVersion:()=>nt});var S=class extends Error{constructor(e){super(e),this.name="NiftiIOError"}};var nt=(n=>(n.NIFTI1="nifti1",n.NIFTI1_PAIR="nifti1_pair",n.NIFTI2="nifti2",n.NIFTI2_PAIR="nifti2_pair",n.NONE="none",n))(nt||{}),et=344,it=4,B={SINGLE:[110,105,49],PAIR:[110,43,49]},v={SINGLE:[110,105,50],PAIR:[110,43,50]},_t=348;function ot(c){if(c.byteLength<_t)return"none";let e=new DataView(c),t=e.getUint8(et),l=e.getUint8(et+1),s=e.getUint8(et+2);if(t===B.SINGLE[0]&&l===B.SINGLE[1]&&s===B.SINGLE[2])return"nifti1";if(t===B.PAIR[0]&&l===B.PAIR[1]&&s===B.PAIR[2])return"nifti1_pair";let n=e.getUint8(it),r=e.getUint8(it+1),i=e.getUint8(it+2);return n===v.SINGLE[0]&&r===v.SINGLE[1]&&i===v.SINGLE[2]?"nifti2":n===v.PAIR[0]&&r===v.PAIR[1]&&i===v.PAIR[2]?"nifti2_pair":"none"}var P,R,z,O,D=class{constructor({esize:e,ecode:t,edata:l,littleEndian:s}){k(this,P);k(this,R);k(this,z);k(this,O);if(e%16!==0)throw new Error("Invalid NIFTI extension: size must be divisible by 16");G(this,P,e),G(this,R,t),G(this,z,l),G(this,O,s)}get size(){return b(this,P)}get code(){return b(this,R)}get data(){return b(this,z)}get littleEndian(){return b(this,O)}toArrayBuffer(){let e=new Uint8Array(b(this,P)),t=new Uint8Array(b(this,z)),l=new DataView(e.buffer);return l.setInt32(0,b(this,P),b(this,O)),l.setInt32(4,b(this,R),b(this,O)),e.set(t,8),e.buffer}};P=new WeakMap,R=new WeakMap,z=new WeakMap,O=new WeakMap;function T(c,e,t){let l=new Uint8Array(c.buffer,e,t-e),s=l.indexOf(0),n=s===-1?l:l.slice(0,s);return new TextDecoder("ascii").decode(n)}function Z(c,e,t,l){let s=[],n=e;for(;n<l;){let r=t,i=c.getInt32(n,t);if(!i)break;if(i+n>l&&(r=!r,i=c.getInt32(n,r),i+n>l))throw new Error("This does not appear to be a valid NIFTI extension");if(i%16!==0)throw new Error("This does not appear to be a NIFTI extension");let d=c.getInt32(n+4,r),a=c.buffer.slice(n+8,n+i),f=new D({esize:i,ecode:d,edata:a,littleEndian:r});s.push(f),n+=i}return s}function X(c,e=!1){let t=typeof c=="string"?Number(c):c;return parseFloat(t.toPrecision(e?5:7))}var h=class h{constructor(){this.littleEndian=!1;this.dim_info=0;this.dims=[];this.intent_p1=0;this.intent_p2=0;this.intent_p3=0;this.intent_code=0;this.datatypeCode=0;this.numBitsPerVoxel=0;this.slice_start=0;this.slice_end=0;this.slice_code=0;this.pixDims=[];this.vox_offset=0;this.scl_slope=1;this.scl_inter=0;this.xyzt_units=0;this.cal_max=0;this.cal_min=0;this.slice_duration=0;this.toffset=0;this.description="";this.aux_file="";this.intent_name="";this.qform_code=0;this.sform_code=0;this.quatern_a=0;this.quatern_b=0;this.quatern_c=0;this.quatern_d=0;this.qoffset_x=0;this.qoffset_y=0;this.qoffset_z=0;this.affine=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];this.qfac=1;this.magic="0";this.isHDR=!1;this.extensionFlag=[0,0,0,0];this.extensionSize=0;this.extensionCode=0;this.extensions=[];this.getDatatypeCodeString=function(e){return e===h.TYPE_UINT8?"1-Byte Unsigned Integer":e===h.TYPE_INT16?"2-Byte Signed Integer":e===h.TYPE_INT32?"4-Byte Signed Integer":e===h.TYPE_FLOAT32?"4-Byte Float":e===h.TYPE_FLOAT64?"8-Byte Float":e===h.TYPE_RGB24?"RGB":e===h.TYPE_INT8?"1-Byte Signed Integer":e===h.TYPE_UINT16?"2-Byte Unsigned Integer":e===h.TYPE_UINT32?"4-Byte Unsigned Integer":e===h.TYPE_INT64?"8-Byte Signed Integer":e===h.TYPE_UINT64?"8-Byte Unsigned Integer":"Unknown"};this.getTransformCodeString=function(e){return e===h.XFORM_SCANNER_ANAT?"Scanner":e===h.XFORM_ALIGNED_ANAT?"Aligned":e===h.XFORM_TALAIRACH?"Talairach":e===h.XFORM_MNI_152?"MNI":"Unknown"};this.getUnitsCodeString=function(e){return e===h.UNITS_METER?"Meters":e===h.UNITS_MM?"Millimeters":e===h.UNITS_MICRON?"Microns":e===h.UNITS_SEC?"Seconds":e===h.UNITS_MSEC?"Milliseconds":e===h.UNITS_USEC?"Microseconds":e===h.UNITS_HZ?"Hz":e===h.UNITS_PPM?"PPM":e===h.UNITS_RADS?"Rads":"Unknown"};this.nifti_mat33_mul=function(e,t){let l=[[0,0,0],[0,0,0],[0,0,0]],s,n;for(s=0;s<3;s+=1)for(n=0;n<3;n+=1)l[s][n]=e[s][0]*t[0][n]+e[s][1]*t[1][n]+e[s][2]*t[2][n];return l};this.nifti_mat33_determ=function(e){let t,l,s,n,r,i,d,a,f;return t=e[0][0],l=e[0][1],s=e[0][2],n=e[1][0],r=e[1][1],i=e[1][2],d=e[2][0],a=e[2][1],f=e[2][2],t*r*f-t*a*i-n*l*f+n*a*s+d*l*i-d*r*s}}static fromBytes(e){let t=new h;return t.readHeader(e),t}readHeader(e){let t=new DataView(e),l=t.getInt32(0,this.littleEndian),s,n,r,i;if(l!==h.MAGIC_COOKIE&&(this.littleEndian=!0,l=t.getInt32(0,this.littleEndian)),l!==h.MAGIC_COOKIE)throw new Error("This does not appear to be a NIFTI file!");for(this.dim_info=t.getInt8(39),s=0;s<8;s+=1)i=40+s*2,this.dims[s]=t.getInt16(i,this.littleEndian);for(this.intent_p1=t.getFloat32(56,this.littleEndian),this.intent_p2=t.getFloat32(60,this.littleEndian),this.intent_p3=t.getFloat32(64,this.littleEndian),this.intent_code=t.getInt16(68,this.littleEndian),this.datatypeCode=t.getInt16(70,this.littleEndian),this.numBitsPerVoxel=t.getInt16(72,this.littleEndian),this.slice_start=t.getInt16(74,this.littleEndian),s=0;s<8;s+=1)i=76+s*4,this.pixDims[s]=t.getFloat32(i,this.littleEndian);if(this.vox_offset=t.getFloat32(108,this.littleEndian),this.scl_slope=t.getFloat32(112,this.littleEndian),this.scl_inter=t.getFloat32(116,this.littleEndian),this.slice_end=t.getInt16(120,this.littleEndian),this.slice_code=t.getInt8(122),this.xyzt_units=t.getInt8(123),this.cal_max=t.getFloat32(124,this.littleEndian),this.cal_min=t.getFloat32(128,this.littleEndian),this.slice_duration=t.getFloat32(132,this.littleEndian),this.toffset=t.getFloat32(136,this.littleEndian),this.description=T(t,148,228),this.aux_file=T(t,228,252),this.qform_code=t.getInt16(252,this.littleEndian),this.sform_code=t.getInt16(254,this.littleEndian),this.quatern_b=t.getFloat32(256,this.littleEndian),this.quatern_c=t.getFloat32(260,this.littleEndian),this.quatern_d=t.getFloat32(264,this.littleEndian),this.quatern_a=Math.sqrt(1-(Math.pow(this.quatern_b,2)+Math.pow(this.quatern_c,2)+Math.pow(this.quatern_d,2))),this.qoffset_x=t.getFloat32(268,this.littleEndian),this.qoffset_y=t.getFloat32(272,this.littleEndian),this.qoffset_z=t.getFloat32(276,this.littleEndian),this.qform_code<1&&this.sform_code<1&&(this.affine[0][0]=this.pixDims[1],this.affine[1][1]=this.pixDims[2],this.affine[2][2]=this.pixDims[3]),this.qform_code>0&&this.sform_code<this.qform_code){let d=this.quatern_a,a=this.quatern_b,f=this.quatern_c,o=this.quatern_d;for(this.qfac=this.pixDims[0]===0?1:this.pixDims[0],this.quatern_R=[[d*d+a*a-f*f-o*o,2*a*f-2*d*o,2*a*o+2*d*f],[2*a*f+2*d*o,d*d+f*f-a*a-o*o,2*f*o-2*d*a],[2*a*o-2*d*f,2*f*o+2*d*a,d*d+o*o-f*f-a*a]],n=0;n<3;n+=1)for(r=0;r<3;r+=1)this.affine[n][r]=this.quatern_R[n][r]*this.pixDims[r+1],r===2&&(this.affine[n][r]*=this.qfac);this.affine[0][3]=this.qoffset_x,this.affine[1][3]=this.qoffset_y,this.affine[2][3]=this.qoffset_z}else if(this.sform_code>0)for(n=0;n<3;n+=1)for(r=0;r<4;r+=1)i=280+(n*4+r)*4,this.affine[n][r]=t.getFloat32(i,this.littleEndian);if(this.affine[3][0]=0,this.affine[3][1]=0,this.affine[3][2]=0,this.affine[3][3]=1,this.intent_name=T(t,328,344),this.magic=T(t,344,348),this.isHDR=this.magic===String.fromCharCode.apply(null,h.MAGIC_NUMBER2),t.byteLength>h.MAGIC_COOKIE){this.extensionFlag[0]=t.getInt8(348),this.extensionFlag[1]=t.getInt8(349),this.extensionFlag[2]=t.getInt8(350),this.extensionFlag[3]=t.getInt8(351);let d=!0;!this.isHDR&&this.vox_offset<=352&&(d=!1),t.byteLength<=368&&(d=!1),d&&this.extensionFlag[0]&&(this.extensions=Z(t,this.getExtensionLocation(),this.littleEndian,this.vox_offset),this.extensionSize=this.extensions[0].size,this.extensionCode=this.extensions[0].code)}}toFormattedString(){let e=X,t="";return t+="Dim Info = "+this.dim_info+`
`,t+="Image Dimensions (1-8): "+this.dims[0]+", "+this.dims[1]+", "+this.dims[2]+", "+this.dims[3]+", "+this.dims[4]+", "+this.dims[5]+", "+this.dims[6]+", "+this.dims[7]+`
`,t+="Intent Parameters (1-3): "+this.intent_p1+", "+this.intent_p2+", "+this.intent_p3+`
`,t+="Intent Code = "+this.intent_code+`
`,t+="Datatype = "+this.datatypeCode+" ("+this.getDatatypeCodeString(this.datatypeCode)+`)
`,t+="Bits Per Voxel = "+this.numBitsPerVoxel+`
`,t+="Slice Start = "+this.slice_start+`
`,t+="Voxel Dimensions (1-8): "+e(this.pixDims[0])+", "+e(this.pixDims[1])+", "+e(this.pixDims[2])+", "+e(this.pixDims[3])+", "+e(this.pixDims[4])+", "+e(this.pixDims[5])+", "+e(this.pixDims[6])+", "+e(this.pixDims[7])+`
`,t+="Image Offset = "+this.vox_offset+`
`,t+="Data Scale:  Slope = "+e(this.scl_slope)+"  Intercept = "+e(this.scl_inter)+`
`,t+="Slice End = "+this.slice_end+`
`,t+="Slice Code = "+this.slice_code+`
`,t+="Units Code = "+this.xyzt_units+" ("+this.getUnitsCodeString(h.SPATIAL_UNITS_MASK&this.xyzt_units)+", "+this.getUnitsCodeString(h.TEMPORAL_UNITS_MASK&this.xyzt_units)+`)
`,t+="Display Range:  Max = "+e(this.cal_max)+"  Min = "+e(this.cal_min)+`
`,t+="Slice Duration = "+this.slice_duration+`
`,t+="Time Axis Shift = "+this.toffset+`
`,t+='Description: "'+this.description+`"
`,t+='Auxiliary File: "'+this.aux_file+`"
`,t+="Q-Form Code = "+this.qform_code+" ("+this.getTransformCodeString(this.qform_code)+`)
`,t+="S-Form Code = "+this.sform_code+" ("+this.getTransformCodeString(this.sform_code)+`)
`,t+="Quaternion Parameters:  b = "+e(this.quatern_b)+"  c = "+e(this.quatern_c)+"  d = "+e(this.quatern_d)+`
`,t+="Quaternion Offsets:  x = "+this.qoffset_x+"  y = "+this.qoffset_y+"  z = "+this.qoffset_z+`
`,t+="S-Form Parameters X: "+e(this.affine[0][0])+", "+e(this.affine[0][1])+", "+e(this.affine[0][2])+", "+e(this.affine[0][3])+`
`,t+="S-Form Parameters Y: "+e(this.affine[1][0])+", "+e(this.affine[1][1])+", "+e(this.affine[1][2])+", "+e(this.affine[1][3])+`
`,t+="S-Form Parameters Z: "+e(this.affine[2][0])+", "+e(this.affine[2][1])+", "+e(this.affine[2][2])+", "+e(this.affine[2][3])+`
`,t+='Intent Name: "'+this.intent_name+`"
`,this.extensionFlag[0]&&(t+="Extension: Size = "+this.extensionSize+"  Code = "+this.extensionCode+`
`),t}getQformMat(){return this.convertNiftiQFormToNiftiSForm(this.quatern_b,this.quatern_c,this.quatern_d,this.qoffset_x,this.qoffset_y,this.qoffset_z,this.pixDims[1],this.pixDims[2],this.pixDims[3],this.pixDims[0])}convertNiftiQFormToNiftiSForm(e,t,l,s,n,r,i,d,a,f){let o=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],u,p=e,m=t,_=l,x,F,g;return o[3][0]=o[3][1]=o[3][2]=0,o[3][3]=1,u=1-(p*p+m*m+_*_),u<1e-7?(u=1/Math.sqrt(p*p+m*m+_*_),p*=u,m*=u,_*=u,u=0):u=Math.sqrt(u),x=i>0?i:1,F=d>0?d:1,g=a>0?a:1,f<0&&(g=-g),o[0][0]=(u*u+p*p-m*m-_*_)*x,o[0][1]=2*(p*m-u*_)*F,o[0][2]=2*(p*_+u*m)*g,o[1][0]=2*(p*m+u*_)*x,o[1][1]=(u*u+m*m-p*p-_*_)*F,o[1][2]=2*(m*_-u*p)*g,o[2][0]=2*(p*_-u*m)*x,o[2][1]=2*(m*_+u*p)*F,o[2][2]=(u*u+_*_-m*m-p*p)*g,o[0][3]=s,o[1][3]=n,o[2][3]=r,o}convertNiftiSFormToNEMA(e){let t,l,s,n,r,i,d,a,f,o,u,p,m,_,x,F,g,L,K,Q,j,$,W,J,V,H,y,I,N,w,C,U,q,M;if(x=0,y=[[0,0,0],[0,0,0],[0,0,0]],I=[[0,0,0],[0,0,0],[0,0,0]],t=e[0][0],l=e[0][1],s=e[0][2],n=e[1][0],r=e[1][1],i=e[1][2],d=e[2][0],a=e[2][1],f=e[2][2],o=Math.sqrt(t*t+n*n+d*d),o===0||(t/=o,n/=o,d/=o,o=Math.sqrt(l*l+r*r+a*a),o===0))return null;if(l/=o,r/=o,a/=o,o=t*l+n*r+d*a,Math.abs(o)>1e-4){if(l-=o*t,r-=o*n,a-=o*d,o=Math.sqrt(l*l+r*r+a*a),o===0)return null;l/=o,r/=o,a/=o}if(o=Math.sqrt(s*s+i*i+f*f),o===0?(s=n*a-d*r,i=d*l-a*t,f=t*r-n*l):(s/=o,i/=o,f/=o),o=t*s+n*i+d*f,Math.abs(o)>1e-4){if(s-=o*t,i-=o*n,f-=o*d,o=Math.sqrt(s*s+i*i+f*f),o===0)return null;s/=o,i/=o,f/=o}if(o=l*s+r*i+a*f,Math.abs(o)>1e-4){if(s-=o*l,i-=o*r,f-=o*a,o=Math.sqrt(s*s+i*i+f*f),o===0)return null;s/=o,i/=o,f/=o}if(y[0][0]=t,y[0][1]=l,y[0][2]=s,y[1][0]=n,y[1][1]=r,y[1][2]=i,y[2][0]=d,y[2][1]=a,y[2][2]=f,u=this.nifti_mat33_determ(y),u===0)return null;for(H=-666,K=$=W=J=1,Q=2,j=3,m=1;m<=3;m+=1)for(_=1;_<=3;_+=1)if(m!==_){for(x=1;x<=3;x+=1)if(!(m===x||_===x))for(I[0][0]=I[0][1]=I[0][2]=I[1][0]=I[1][1]=I[1][2]=I[2][0]=I[2][1]=I[2][2]=0,F=-1;F<=1;F+=2)for(g=-1;g<=1;g+=2)for(L=-1;L<=1;L+=2)I[0][m-1]=F,I[1][_-1]=g,I[2][x-1]=L,p=this.nifti_mat33_determ(I),p*u>0&&(V=this.nifti_mat33_mul(I,y),o=V[0][0]+V[1][1]+V[2][2],o>H&&(H=o,K=m,Q=_,j=x,$=F,W=g,J=L))}switch(N=w=C=U=q=M="",K*$){case 1:N="X",U="+";break;case-1:N="X",U="-";break;case 2:N="Y",U="+";break;case-2:N="Y",U="-";break;case 3:N="Z",U="+";break;case-3:N="Z",U="-";break}switch(Q*W){case 1:w="X",q="+";break;case-1:w="X",q="-";break;case 2:w="Y",q="+";break;case-2:w="Y",q="-";break;case 3:w="Z",q="+";break;case-3:w="Z",q="-";break}switch(j*J){case 1:C="X",M="+";break;case-1:C="X",M="-";break;case 2:C="Y",M="+";break;case-2:C="Y",M="-";break;case 3:C="Z",M="+";break;case-3:C="Z",M="-";break}return N+w+C+U+q+M}getExtensionLocation(){return h.MAGIC_COOKIE+4}getExtensionSize(e){return e.getInt32(this.getExtensionLocation(),this.littleEndian)}getExtensionCode(e){return e.getInt32(this.getExtensionLocation()+4,this.littleEndian)}addExtension(e,t=-1){t==-1?this.extensions.push(e):this.extensions.splice(t,0,e),this.vox_offset+=e.size}removeExtension(e){let t=this.extensions[e];t&&(this.vox_offset-=t.size),this.extensions.splice(e,1)}toArrayBuffer(e=!1){let s=352;if(e)for(let a of this.extensions)s+=a.size;let n=new TextEncoder,r=new Uint8Array(s),i=new DataView(r.buffer);i.setInt32(0,348,this.littleEndian),i.setUint8(39,this.dim_info);for(let a=0;a<8;a++)i.setUint16(40+2*a,this.dims[a],this.littleEndian);i.setFloat32(56,this.intent_p1,this.littleEndian),i.setFloat32(60,this.intent_p2,this.littleEndian),i.setFloat32(64,this.intent_p3,this.littleEndian),i.setInt16(68,this.intent_code,this.littleEndian),i.setInt16(70,this.datatypeCode,this.littleEndian),i.setInt16(72,this.numBitsPerVoxel,this.littleEndian),i.setInt16(74,this.slice_start,this.littleEndian);for(let a=0;a<8;a++)i.setFloat32(76+4*a,this.pixDims[a],this.littleEndian);i.setFloat32(108,this.vox_offset,this.littleEndian),i.setFloat32(112,this.scl_slope,this.littleEndian),i.setFloat32(116,this.scl_inter,this.littleEndian),i.setInt16(120,this.slice_end,this.littleEndian),i.setUint8(122,this.slice_code),i.setUint8(123,this.xyzt_units),i.setFloat32(124,this.cal_max,this.littleEndian),i.setFloat32(128,this.cal_min,this.littleEndian),i.setFloat32(132,this.slice_duration,this.littleEndian),i.setFloat32(136,this.toffset,this.littleEndian),r.set(n.encode(this.description),148),r.set(n.encode(this.aux_file),228),i.setInt16(252,this.qform_code,this.littleEndian),i.setInt16(254,this.sform_code,this.littleEndian),i.setFloat32(256,this.quatern_b,this.littleEndian),i.setFloat32(260,this.quatern_c,this.littleEndian),i.setFloat32(264,this.quatern_d,this.littleEndian),i.setFloat32(268,this.qoffset_x,this.littleEndian),i.setFloat32(272,this.qoffset_y,this.littleEndian),i.setFloat32(276,this.qoffset_z,this.littleEndian);let d=this.affine.flat();for(let a=0;a<12;a++)i.setFloat32(280+4*a,d[a],this.littleEndian);if(r.set(n.encode(this.intent_name),328),r.set(n.encode(this.magic),344),e){r.set(Uint8Array.from([1,0,0,0]),348);let a=this.getExtensionLocation();for(let f of this.extensions)i.setInt32(a,f.size,f.littleEndian),i.setInt32(a+4,f.code,f.littleEndian),r.set(new Uint8Array(f.data),a+8),a+=f.size}else r.set(new Uint8Array(4).fill(0),348);return r.buffer}};h.TYPE_NONE=0,h.TYPE_BINARY=1,h.TYPE_UINT8=2,h.TYPE_INT16=4,h.TYPE_INT32=8,h.TYPE_FLOAT32=16,h.TYPE_COMPLEX64=32,h.TYPE_FLOAT64=64,h.TYPE_RGB24=128,h.TYPE_INT8=256,h.TYPE_UINT16=512,h.TYPE_UINT32=768,h.TYPE_INT64=1024,h.TYPE_UINT64=1280,h.TYPE_FLOAT128=1536,h.TYPE_COMPLEX128=1792,h.TYPE_COMPLEX256=2048,h.XFORM_UNKNOWN=0,h.XFORM_SCANNER_ANAT=1,h.XFORM_ALIGNED_ANAT=2,h.XFORM_TALAIRACH=3,h.XFORM_MNI_152=4,h.SPATIAL_UNITS_MASK=7,h.TEMPORAL_UNITS_MASK=56,h.UNITS_UNKNOWN=0,h.UNITS_METER=1,h.UNITS_MM=2,h.UNITS_MICRON=3,h.UNITS_SEC=8,h.UNITS_MSEC=16,h.UNITS_USEC=24,h.UNITS_HZ=32,h.UNITS_PPM=40,h.UNITS_RADS=48,h.MAGIC_COOKIE=348,h.STANDARD_HEADER_SIZE=348,h.MAGIC_NUMBER_LOCATION=344,h.MAGIC_NUMBER=[110,43,49],h.MAGIC_NUMBER2=[110,105,49],h.EXTENSION_HEADER_SIZE=8;var E=h;var A=class A{constructor(){this.littleEndian=!1;this.dim_info=0;this.dims=[];this.intent_p1=0;this.intent_p2=0;this.intent_p3=0;this.intent_code=0;this.datatypeCode=0;this.numBitsPerVoxel=0;this.slice_start=0;this.slice_end=0;this.slice_code=0;this.pixDims=[];this.vox_offset=0;this.scl_slope=1;this.scl_inter=0;this.xyzt_units=0;this.cal_max=0;this.cal_min=0;this.slice_duration=0;this.toffset=0;this.description="";this.aux_file="";this.intent_name="";this.qform_code=0;this.sform_code=0;this.quatern_b=0;this.quatern_c=0;this.quatern_d=0;this.qoffset_x=0;this.qoffset_y=0;this.qoffset_z=0;this.affine=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];this.magic="0";this.extensionFlag=[0,0,0,0];this.extensions=[];this.extensionSize=0;this.extensionCode=0;this.getExtensionLocation=function(){return A.MAGIC_COOKIE+4};this.getExtensionSize=E.prototype.getExtensionSize;this.getExtensionCode=E.prototype.getExtensionCode;this.addExtension=E.prototype.addExtension;this.removeExtension=E.prototype.removeExtension;this.getDatatypeCodeString=E.prototype.getDatatypeCodeString;this.getTransformCodeString=E.prototype.getTransformCodeString;this.getUnitsCodeString=E.prototype.getUnitsCodeString;this.getQformMat=E.prototype.getQformMat;this.convertNiftiQFormToNiftiSForm=E.prototype.convertNiftiQFormToNiftiSForm;this.convertNiftiSFormToNEMA=E.prototype.convertNiftiSFormToNEMA;this.nifti_mat33_mul=E.prototype.nifti_mat33_mul;this.nifti_mat33_determ=E.prototype.nifti_mat33_determ}static fromBytes(e){let t=new A;return t.readHeader(e),t}readHeader(e){let t=new DataView(e),l=t.getInt32(0,this.littleEndian),s,n,r,i;if(l!==A.MAGIC_COOKIE&&(this.littleEndian=!0,l=t.getInt32(0,this.littleEndian)),l!==A.MAGIC_COOKIE)throw new Error("This does not appear to be a NIFTI file!");for(this.magic=T(t,4,12),this.datatypeCode=t.getInt16(12,this.littleEndian),this.numBitsPerVoxel=t.getInt16(14,this.littleEndian),s=0;s<8;s+=1)i=16+s*8,this.dims[s]=Number(t.getBigInt64(i,this.littleEndian));for(this.intent_p1=t.getFloat64(80,this.littleEndian),this.intent_p2=t.getFloat64(88,this.littleEndian),this.intent_p3=t.getFloat64(96,this.littleEndian),s=0;s<8;s+=1)i=104+s*8,this.pixDims[s]=t.getFloat64(i,this.littleEndian);for(this.vox_offset=Number(t.getBigInt64(168,this.littleEndian)),this.scl_slope=t.getFloat64(176,this.littleEndian),this.scl_inter=t.getFloat64(184,this.littleEndian),this.cal_max=t.getFloat64(192,this.littleEndian),this.cal_min=t.getFloat64(200,this.littleEndian),this.slice_duration=t.getFloat64(208,this.littleEndian),this.toffset=t.getFloat64(216,this.littleEndian),this.slice_start=Number(t.getBigInt64(224,this.littleEndian)),this.slice_end=Number(t.getBigInt64(232,this.littleEndian)),this.description=T(t,240,320),this.aux_file=T(t,320,344),this.qform_code=t.getInt32(344,this.littleEndian),this.sform_code=t.getInt32(348,this.littleEndian),this.quatern_b=t.getFloat64(352,this.littleEndian),this.quatern_c=t.getFloat64(360,this.littleEndian),this.quatern_d=t.getFloat64(368,this.littleEndian),this.qoffset_x=t.getFloat64(376,this.littleEndian),this.qoffset_y=t.getFloat64(384,this.littleEndian),this.qoffset_z=t.getFloat64(392,this.littleEndian),n=0;n<3;n+=1)for(r=0;r<4;r+=1)i=400+(n*4+r)*8,this.affine[n][r]=t.getFloat64(i,this.littleEndian);this.affine[3][0]=0,this.affine[3][1]=0,this.affine[3][2]=0,this.affine[3][3]=1,this.slice_code=t.getInt32(496,this.littleEndian),this.xyzt_units=t.getInt32(500,this.littleEndian),this.intent_code=t.getInt32(504,this.littleEndian),this.intent_name=T(t,508,524),this.dim_info=t.getInt8(524),t.byteLength>A.MAGIC_COOKIE&&(this.extensionFlag[0]=t.getInt8(540),this.extensionFlag[1]=t.getInt8(541),this.extensionFlag[2]=t.getInt8(542),this.extensionFlag[3]=t.getInt8(543),this.extensionFlag[0]&&(this.extensions=Z(t,this.getExtensionLocation(),this.littleEndian,this.vox_offset),this.extensionSize=this.extensions[0].size,this.extensionCode=this.extensions[0].code))}toFormattedString(){let e=X,t="";return t+="Datatype = "+ +this.datatypeCode+" ("+this.getDatatypeCodeString(this.datatypeCode)+`)
`,t+="Bits Per Voxel =  = "+this.numBitsPerVoxel+`
`,t+="Image Dimensions (1-8): "+this.dims[0]+", "+this.dims[1]+", "+this.dims[2]+", "+this.dims[3]+", "+this.dims[4]+", "+this.dims[5]+", "+this.dims[6]+", "+this.dims[7]+`
`,t+="Intent Parameters (1-3): "+this.intent_p1+", "+this.intent_p2+", "+this.intent_p3+`
`,t+="Voxel Dimensions (1-8): "+e(this.pixDims[0])+", "+e(this.pixDims[1])+", "+e(this.pixDims[2])+", "+e(this.pixDims[3])+", "+e(this.pixDims[4])+", "+e(this.pixDims[5])+", "+e(this.pixDims[6])+", "+e(this.pixDims[7])+`
`,t+="Image Offset = "+this.vox_offset+`
`,t+="Data Scale:  Slope = "+e(this.scl_slope)+"  Intercept = "+e(this.scl_inter)+`
`,t+="Display Range:  Max = "+e(this.cal_max)+"  Min = "+e(this.cal_min)+`
`,t+="Slice Duration = "+this.slice_duration+`
`,t+="Time Axis Shift = "+this.toffset+`
`,t+="Slice Start = "+this.slice_start+`
`,t+="Slice End = "+this.slice_end+`
`,t+='Description: "'+this.description+`"
`,t+='Auxiliary File: "'+this.aux_file+`"
`,t+="Q-Form Code = "+this.qform_code+" ("+this.getTransformCodeString(this.qform_code)+`)
`,t+="S-Form Code = "+this.sform_code+" ("+this.getTransformCodeString(this.sform_code)+`)
`,t+="Quaternion Parameters:  b = "+e(this.quatern_b)+"  c = "+e(this.quatern_c)+"  d = "+e(this.quatern_d)+`
`,t+="Quaternion Offsets:  x = "+this.qoffset_x+"  y = "+this.qoffset_y+"  z = "+this.qoffset_z+`
`,t+="S-Form Parameters X: "+e(this.affine[0][0])+", "+e(this.affine[0][1])+", "+e(this.affine[0][2])+", "+e(this.affine[0][3])+`
`,t+="S-Form Parameters Y: "+e(this.affine[1][0])+", "+e(this.affine[1][1])+", "+e(this.affine[1][2])+", "+e(this.affine[1][3])+`
`,t+="S-Form Parameters Z: "+e(this.affine[2][0])+", "+e(this.affine[2][1])+", "+e(this.affine[2][2])+", "+e(this.affine[2][3])+`
`,t+="Slice Code = "+this.slice_code+`
`,t+="Units Code = "+this.xyzt_units+" ("+this.getUnitsCodeString(E.SPATIAL_UNITS_MASK&this.xyzt_units)+", "+this.getUnitsCodeString(E.TEMPORAL_UNITS_MASK&this.xyzt_units)+`)
`,t+="Intent Code = "+this.intent_code+`
`,t+='Intent Name: "'+this.intent_name+`"
`,t+="Dim Info = "+this.dim_info+`
`,t}toArrayBuffer(e=!1){let s=544;if(e)for(let a of this.extensions)s+=a.size;let n=new TextEncoder,r=new Uint8Array(s),i=new DataView(r.buffer);i.setInt32(0,540,this.littleEndian),r.set(n.encode(this.magic),4),i.setInt16(12,this.datatypeCode,this.littleEndian),i.setInt16(14,this.numBitsPerVoxel,this.littleEndian);for(let a=0;a<8;a++)i.setBigInt64(16+8*a,BigInt(this.dims[a]),this.littleEndian);i.setFloat64(80,this.intent_p1,this.littleEndian),i.setFloat64(88,this.intent_p2,this.littleEndian),i.setFloat64(96,this.intent_p3,this.littleEndian);for(let a=0;a<8;a++)i.setFloat64(104+8*a,this.pixDims[a],this.littleEndian);i.setBigInt64(168,BigInt(this.vox_offset),this.littleEndian),i.setFloat64(176,this.scl_slope,this.littleEndian),i.setFloat64(184,this.scl_inter,this.littleEndian),i.setFloat64(192,this.cal_max,this.littleEndian),i.setFloat64(200,this.cal_min,this.littleEndian),i.setFloat64(208,this.slice_duration,this.littleEndian),i.setFloat64(216,this.toffset,this.littleEndian),i.setBigInt64(224,BigInt(this.slice_start),this.littleEndian),i.setBigInt64(232,BigInt(this.slice_end),this.littleEndian),r.set(n.encode(this.description),240),r.set(n.encode(this.aux_file),320),i.setInt32(344,this.qform_code,this.littleEndian),i.setInt32(348,this.sform_code,this.littleEndian),i.setFloat64(352,this.quatern_b,this.littleEndian),i.setFloat64(360,this.quatern_c,this.littleEndian),i.setFloat64(368,this.quatern_d,this.littleEndian),i.setFloat64(376,this.qoffset_x,this.littleEndian),i.setFloat64(384,this.qoffset_y,this.littleEndian),i.setFloat64(392,this.qoffset_z,this.littleEndian);let d=this.affine.flat();for(let a=0;a<12;a++)i.setFloat64(400+8*a,d[a],this.littleEndian);if(i.setInt32(496,this.slice_code,this.littleEndian),i.setInt32(500,this.xyzt_units,this.littleEndian),i.setInt32(504,this.intent_code,this.littleEndian),r.set(n.encode(this.intent_name),508),i.setUint8(524,this.dim_info),e){r.set(Uint8Array.from([1,0,0,0]),540);let a=this.getExtensionLocation();for(let f of this.extensions)i.setInt32(a,f.size,f.littleEndian),i.setInt32(a+4,f.code,f.littleEndian),r.set(new Uint8Array(f.data),a+8),a+=f.size}else r.set(new Uint8Array(4).fill(0),540);return r.buffer}};A.MAGIC_COOKIE=540,A.MAGIC_NUMBER_LOCATION=4,A.MAGIC_NUMBER=[110,43,50,0,13,10,26,10],A.MAGIC_NUMBER2=[110,105,50,0,13,10,26,10];var Y=A;async function lt(c){let e=c.getReader(),{done:t,value:l}=await e.read();if(t)return e.releaseLock(),new ReadableStream({start(r){r.close()}});if(!l||l.length<2)return e.releaseLock(),new ReadableStream({start(r){l&&r.enqueue(l),r.close()}});let s=l[0]===31&&l[1]===139,n=new ReadableStream({async start(r){try{for(r.enqueue(l);;){let{done:i,value:d}=await e.read();if(i){r.close(),e.releaseLock();break}r.enqueue(d)}}catch(i){r.error(i),e.releaseLock()}}});return s?n.pipeThrough(new DecompressionStream("gzip")):n}var st=class{constructor(e,t){this.options=t;this.header=null;this.stopped=!1;this.buffer=new Uint8Array(0);this.bufferOffset=0;this.totalBytesRead=0;this.dataPosition=0;this.stream=e}async setup(){let e=await lt(this.stream);e&&(this.stream=e),this.reader=this.stream.getReader()}async stop(){this.stopped=!0,await this.reader?.cancel()}async readBytes(e){if(!this.reader)throw new S("Reader not initialized");if(this.buffer.length-this.bufferOffset>=e){let t=this.buffer.slice(this.bufferOffset,this.bufferOffset+e);return this.bufferOffset+=e,t}if(this.buffer.length-this.bufferOffset>0){let t=this.buffer.slice(this.bufferOffset),{done:l,value:s}=await this.reader.read();if(l){if(t.length<e)throw new S(`Unexpected end of stream: needed ${e} bytes but got ${t.length}`);return t}return this.buffer=new Uint8Array(t.length+s.length),this.buffer.set(t),this.buffer.set(s,t.length),this.bufferOffset=0,this.readBytes(e)}else{let{done:t,value:l}=await this.reader.read();if(t)throw new S(`Unexpected end of stream: needed ${e} bytes but got 0`);return this.buffer=l,this.bufferOffset=0,this.readBytes(e)}}async readHeader(){let e=await this.readBytes(348);switch(ot(e.buffer)){case"nifti1":case"nifti1_pair":return E.fromBytes(e.buffer);case"nifti2":case"nifti2_pair":{let l=await this.readBytes(192),s=new Uint8Array(540);return s.set(e),s.set(l,348),Y.fromBytes(s.buffer)}case"none":throw new S("Not a valid NIFTI file")}}async readExtension(){if(!this.header||!this.reader)throw new S("Cannot read extension before header");if((await this.readBytes(4))[0]===0)return null;let t=await this.readBytes(8),l=this.header.littleEndian,s=new DataView(t.buffer),n=s.getInt32(0,l),r=s.getInt32(4,l),i=n-8,d=await this.readBytes(i);return new D({esize:n,ecode:r,edata:d.buffer,littleEndian:l})}async readNextSlice(){if(!this.header)throw new S("Cannot read slice before header");if(!this.options.sliceDimension){if(this.dataPosition===0&&this.buffer.length>this.bufferOffset){let i=this.buffer.slice(this.bufferOffset);return this.buffer=new Uint8Array(0),this.bufferOffset=0,this.dataPosition++,{data:i.buffer,indices:[]}}let{done:n,value:r}=await this.reader.read();return n?null:(this.dataPosition++,{data:r.buffer,indices:[]})}let e=this.header.dims[0],t=this.header.dims,s=this.header.numBitsPerVoxel/8;for(let n=1;n<=(this.options.sliceDimension||2);n++)t[n]>0&&(s*=t[n]);try{let n=await this.readBytes(s),r=new Array(e).fill(0);return r[this.options.sliceDimension+1]=this.dataPosition++,{data:n.buffer,indices:r}}catch(n){if(n instanceof S)return null;throw n}}async start(){if(await this.setup(),!!this.reader)try{if(this.stopped)return;if(this.header=await this.readHeader(),this.options.onHeader){if(await this.options.onHeader(this.header)){await this.stop();return}}else if(!this.options.onExtension&&!this.options.onSlice){await this.stop();return}if(!this.stopped){let e=await this.readExtension();if(this.options.onExtension){if(await this.options.onExtension(e)){await this.stop();return}}else if(!this.options.onSlice){await this.stop();return}}if(!this.options.onSlice){await this.stop();return}for(;!this.stopped;){let e=await this.readNextSlice();if(!e)break;if(await this.options.onSlice(e.data,e.indices,this.header)){await this.stop();break}}}catch(e){this.options.onError&&this.options.onError(e)}finally{this.reader.releaseLock()}}};return mt(pt);})();
//# sourceMappingURL=nifti-stream.js.map
