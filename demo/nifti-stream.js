"use strict";var niftiStream=(()=>{var A=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var U=a=>{throw TypeError(a)};var V=(a,e)=>{for(var i in e)A(a,i,{get:e[i],enumerable:!0})},O=(a,e,i,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of M(e))!z.call(a,n)&&n!==i&&A(a,n,{get:()=>e[n],enumerable:!(t=R(e,n))||t.enumerable});return a};var $=a=>O(A({},"__esModule",{value:!0}),a);var q=(a,e,i)=>e.has(a)||U("Cannot "+i);var f=(a,e,i)=>(q(a,e,"read from private field"),i?i.call(a):e.get(a)),y=(a,e,i)=>e.has(a)?U("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(a):e.set(a,i),N=(a,e,i,t)=>(q(a,e,"write to private field"),t?t.call(a,i):e.set(a,i),i);var C={};V(C,{NiftiExtension:()=>g,NiftiHeader:()=>b,NiftiIOError:()=>l,NiftiStream:()=>D,NiftiVersion:()=>w});var l=class extends Error{constructor(e){super(e),this.name="NiftiIOError"}};var H=new Map([[2,"Uint8 (1 byte)"],[4,"Int16 (2 bytes)"],[8,"Int32 (4 bytes)"],[16,"Float32 (4 bytes)"],[64,"Float64 (8 bytes)"],[128,"RGB (24-bit)"],[256,"Int8 (1 byte)"],[512,"Uint16 (2 bytes)"],[768,"Uint32 (4 bytes)"],[1024,"Int64 (8 bytes)"],[1280,"Uint64 (8 bytes)"]]),k=new Map([[1,"Scanner Anatomical"],[2,"Aligned Anatomical"],[3,"Talairach Space"],[4,"MNI-152 Space"]]),L=new Map([[1,"Meters (m)"],[2,"Millimeters (mm)"],[3,"Micrometers (\u03BCm)"],[8,"Seconds (s)"],[16,"Milliseconds (ms)"],[24,"Microseconds (\u03BCs)"],[32,"Hertz (Hz)"],[40,"Parts per Million (ppm)"],[48,"Radians (rad)"]]),x=7,F=56;function B(a){return H.get(a)??"Unknown"}function S(a){return k.get(a)??"Unknown"}function T(a){return L.get(a)??"Unknown"}var c=348,m=540;var p,E,I,_,g=class{constructor({esize:e,ecode:i,edata:t,littleEndian:n}){y(this,p);y(this,E);y(this,I);y(this,_);if(e%16!==0)throw new Error("Invalid NIFTI extension: size must be divisible by 16");N(this,p,e),N(this,E,i),N(this,I,t),N(this,_,n)}get size(){return f(this,p)}get code(){return f(this,E)}get data(){return f(this,I)}get littleEndian(){return f(this,_)}toArrayBuffer(){let e=new Uint8Array(f(this,p)),i=new Uint8Array(f(this,I)),t=new DataView(e.buffer);return t.setInt32(0,f(this,p),f(this,_)),t.setInt32(4,f(this,E),f(this,_)),e.set(i,8),e.buffer}};p=new WeakMap,E=new WeakMap,I=new WeakMap,_=new WeakMap;function h(a,e,i){let t=new Uint8Array(a.buffer,e,i-e),n=t.indexOf(0),s=n===-1?t:t.slice(0,n);return new TextDecoder("ascii").decode(s)}var w=(s=>(s[s.NIFTI1=0]="NIFTI1",s[s.NIFTI1_PAIR=1]="NIFTI1_PAIR",s[s.NIFTI2=2]="NIFTI2",s[s.NIFTI2_PAIR=3]="NIFTI2_PAIR",s[s.NONE=4]="NONE",s))(w||{}),b=class a{constructor(){this.dim_info=0;this.dims=[0,0,0,0,0,0,0,0];this.intent_p1=0;this.intent_p2=0;this.intent_p3=0;this.intent_code=0;this.datatypeCode=0;this.numBitsPerVoxel=0;this.slice_start=0;this.pixDims=[0,0,0,0,0,0,0,0];this.vox_offset=0;this.scl_slope=1;this.scl_inter=0;this.slice_end=0;this.slice_code=0;this.xyzt_units=0;this.cal_max=0;this.cal_min=0;this.slice_duration=0;this.toffset=0;this.description="";this.aux_file="";this.qform_code=0;this.sform_code=0;this.srow_x=[0,0,0,0];this.srow_y=[0,0,0,0];this.srow_z=[0,0,0,0];this.quatern_b=0;this.quatern_c=0;this.quatern_d=0;this.qoffset_x=0;this.qoffset_y=0;this.qoffset_z=0;this.intent_name="";this.magic="ni1";this.littleEndian=!1}isValid(){return this.getNiftiVersion()!==4}getNiftiVersion(){return{ni1:0,"n+1":1,ni2:2,"n+2":3}[this.magic]||4}getNiftiVersionDisplayName(){return{4:"Unknown",0:"NIFTI-1 (Single File)",1:"NIFTI-1 (Paired Files)",2:"NIFTI-2 (Single File)",3:"NIFTI-2 (Paired Files)"}[this.getNiftiVersion()]}getDatatypeDisplayName(){return B(this.datatypeCode)}getQFormDisplayName(){return S(this.qform_code)}getSFormDisplayName(){return S(this.sform_code)}get spatialUnits(){return this.xyzt_units&x}set spatialUnits(e){this.xyzt_units=this.xyzt_units&~x|e&x}get temporalUnits(){return this.xyzt_units&F}set temporalUnits(e){this.xyzt_units=this.xyzt_units&~F|e&F}getSpatialUnitsDisplayName(){return T(this.spatialUnits)}getTemporalUnitsDisplayName(){return T(this.temporalUnits)}computeAffine(){let e=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];if(this.qform_code<1&&this.sform_code<1)e[0][0]=this.pixDims[1],e[1][1]=this.pixDims[2],e[2][2]=this.pixDims[3];else if(this.qform_code>0&&this.sform_code<this.qform_code){let i=Math.sqrt(1-(Math.pow(this.quatern_b,2)+Math.pow(this.quatern_c,2)+Math.pow(this.quatern_d,2))),t=this.quatern_b,n=this.quatern_c,s=this.quatern_d,r=this.pixDims[0]===0?1:this.pixDims[0],o=[[i*i+t*t-n*n-s*s,2*t*n-2*i*s,2*t*s+2*i*n],[2*t*n+2*i*s,i*i+n*n-t*t-s*s,2*n*s-2*i*t],[2*t*s-2*i*n,2*n*s+2*i*t,i*i+s*s-n*n-t*t]];for(let d=0;d<3;d+=1)for(let u=0;u<3;u+=1)e[d][u]=o[d][u]*this.pixDims[u+1],u===2&&(e[d][u]*=r);e[0][3]=this.qoffset_x,e[1][3]=this.qoffset_y,e[2][3]=this.qoffset_z}else if(this.sform_code>0){let i=[this.srow_x,this.srow_y,this.srow_z];for(let t=0;t<3;t+=1)for(let n=0;n<4;n+=1)e[t][n]=i[t][n]}return e}formatHeader(){let e=n=>Number.isInteger(n)?n.toString():n.toFixed(4),i=(n,s=" \xD7 ")=>n.map(e).join(s),t=n=>n.map(r=>r.map(o=>o.toFixed(4).padStart(12)).join("  ")).map(r=>"    "+r).join(`
`);return`# Image Properties
- Version: ${this.getNiftiVersionDisplayName()}
- Datatype: ${this.getDatatypeDisplayName()} [${this.datatypeCode}]
- Bits/Voxel: ${this.numBitsPerVoxel}
- Dimensions: ${i(this.dims)}
- Voxel Size: ${i(this.pixDims)}

# Transform Information
- Q-Form: ${this.getQFormDisplayName()} [${this.qform_code}]
- S-Form: ${this.getSFormDisplayName()} [${this.sform_code}]
- Quaternion B/C/D: ${e(this.quatern_b)} / ${e(this.quatern_c)} / ${e(this.quatern_d)}
- Q-Offset: ${i([this.qoffset_x,this.qoffset_y,this.qoffset_z],", ")}
- S-Form Rows:
    X: ${i(this.srow_x,", ")}
    Y: ${i(this.srow_y,", ")}
    Z: ${i(this.srow_z,", ")}

# Affine Matrix (computed):
${t(this.computeAffine())}

# Units & Scaling
- Spatial Units: ${this.getSpatialUnitsDisplayName()} [${this.spatialUnits}]
- Temporal Units: ${this.getTemporalUnitsDisplayName()} [${this.temporalUnits}]
- Scale Slope: ${e(this.scl_slope)}
- Scale Intercept: ${e(this.scl_inter)}
- Display Range: ${e(this.cal_min)} to ${e(this.cal_max)}

# Intent & Metadata
- Intent: '${this.intent_name||"none"}' [${this.intent_code}]
- Intent Params: ${e(this.intent_p1)} / ${e(this.intent_p2)} / ${e(this.intent_p3)}
- Description: '${this.description||"none"}'
- Auxiliary File: '${this.aux_file||"none"}'`}static peekVersion(e){if(e.byteLength<4)throw new l("Not enough bytes to identify NIFTI header.");switch(e.getInt32(0,!1)){case 348:return{nifti1:!0,littleEndian:!1};case 1543569408:return{nifti1:!0,littleEndian:!0};case 540:return{nifti1:!1,littleEndian:!1};case 469893120:return{nifti1:!1,littleEndian:!0};default:return}}static parse(e,i){return i.nifti1?this.parseNifti1(e,i.littleEndian):this.parseNifti2(e,i.littleEndian)}static parseNifti1(e,i){if(e.byteLength<c)throw new l("Not enough bytes to parse NIFTI-1 header.");let t=new a;if(i===void 0){let s=a.peekVersion(e);if(s===void 0||!s.nifti1)throw new l("This does not appear to be a NIFTI-1 file!");t.littleEndian=s.littleEndian}else t.littleEndian=i;t.dim_info=e.getInt8(39);for(let s=0;s<8;s+=1){let r=40+s*2;t.dims[s]=e.getInt16(r,t.littleEndian)}t.intent_p1=e.getFloat32(56,t.littleEndian),t.intent_p2=e.getFloat32(60,t.littleEndian),t.intent_p3=e.getFloat32(64,t.littleEndian),t.intent_code=e.getInt16(68,t.littleEndian),t.datatypeCode=e.getInt16(70,t.littleEndian),t.numBitsPerVoxel=e.getInt16(72,t.littleEndian),t.slice_start=e.getInt16(74,t.littleEndian);for(let s=0;s<8;s+=1){let r=76+s*4;t.pixDims[s]=e.getFloat32(r,t.littleEndian)}t.vox_offset=e.getFloat32(108,t.littleEndian),t.scl_slope=e.getFloat32(112,t.littleEndian),t.scl_inter=e.getFloat32(116,t.littleEndian),t.slice_end=e.getInt16(120,t.littleEndian),t.slice_code=e.getInt8(122),t.xyzt_units=e.getInt8(123),t.cal_max=e.getFloat32(124,t.littleEndian),t.cal_min=e.getFloat32(128,t.littleEndian),t.slice_duration=e.getFloat32(132,t.littleEndian),t.toffset=e.getFloat32(136,t.littleEndian),t.description=h(e,148,228),t.aux_file=h(e,228,252),t.qform_code=e.getInt16(252,t.littleEndian),t.sform_code=e.getInt16(254,t.littleEndian),t.quatern_b=e.getFloat32(256,t.littleEndian),t.quatern_c=e.getFloat32(260,t.littleEndian),t.quatern_d=e.getFloat32(264,t.littleEndian),t.qoffset_x=e.getFloat32(268,t.littleEndian),t.qoffset_y=e.getFloat32(272,t.littleEndian),t.qoffset_z=e.getFloat32(276,t.littleEndian);let n=[t.srow_x,t.srow_y,t.srow_z];for(let s=0;s<3;s+=1)for(let r=0;r<4;r+=1){let o=280+(s*4+r)*4;n[s][r]=e.getFloat32(o,t.littleEndian)}return t.intent_name=h(e,328,344),t.magic=h(e,344,348),t}static parseNifti2(e,i){if(e.byteLength<m)throw new l("Not enough bytes to parse NIFTI-2 header.");let t=new a;if(i===void 0){let s=a.peekVersion(e);if(s===void 0||s.nifti1)throw new l("This does not appear to be a NIFTI-2 file!");t.littleEndian=s.littleEndian}else t.littleEndian=i;t.magic=h(e,4,12),t.datatypeCode=e.getInt16(12,t.littleEndian),t.numBitsPerVoxel=e.getInt16(14,t.littleEndian);for(let s=0;s<8;s+=1){let r=16+s*8;t.dims[s]=Number(e.getBigInt64(r,t.littleEndian))}t.intent_p1=e.getFloat64(80,t.littleEndian),t.intent_p2=e.getFloat64(88,t.littleEndian),t.intent_p3=e.getFloat64(96,t.littleEndian);for(let s=0;s<8;s+=1){let r=104+s*8;t.pixDims[s]=e.getFloat64(r,t.littleEndian)}t.vox_offset=Number(e.getBigInt64(168,t.littleEndian)),t.scl_slope=e.getFloat64(176,t.littleEndian),t.scl_inter=e.getFloat64(184,t.littleEndian),t.cal_max=e.getFloat64(192,t.littleEndian),t.cal_min=e.getFloat64(200,t.littleEndian),t.slice_duration=e.getFloat64(208,t.littleEndian),t.toffset=e.getFloat64(216,t.littleEndian),t.slice_start=Number(e.getBigInt64(224,t.littleEndian)),t.slice_end=Number(e.getBigInt64(232,t.littleEndian)),t.description=h(e,240,320),t.aux_file=h(e,320,344),t.qform_code=e.getInt32(344,t.littleEndian),t.sform_code=e.getInt32(348,t.littleEndian),t.quatern_b=e.getFloat64(352,t.littleEndian),t.quatern_c=e.getFloat64(360,t.littleEndian),t.quatern_d=e.getFloat64(368,t.littleEndian),t.qoffset_x=e.getFloat64(376,t.littleEndian),t.qoffset_y=e.getFloat64(384,t.littleEndian),t.qoffset_z=e.getFloat64(392,t.littleEndian);let n=[t.srow_x,t.srow_y,t.srow_z];for(let s=0;s<3;s+=1)for(let r=0;r<4;r+=1){let o=280+(s*4+r)*4;n[s][r]=e.getFloat64(o,t.littleEndian)}return t.slice_code=e.getInt32(496,t.littleEndian),t.xyzt_units=e.getInt32(500,t.littleEndian),t.intent_code=e.getInt32(504,t.littleEndian),t.intent_name=h(e,508,524),t.dim_info=e.getInt8(524),t}serializeNifti1(){let e=c,i=new TextEncoder,t=new Uint8Array(e),n=new DataView(t.buffer);n.setInt32(0,c,this.littleEndian),n.setUint8(39,this.dim_info);for(let o=0;o<8;o++)n.setUint16(40+2*o,this.dims[o],this.littleEndian);n.setFloat32(56,this.intent_p1,this.littleEndian),n.setFloat32(60,this.intent_p2,this.littleEndian),n.setFloat32(64,this.intent_p3,this.littleEndian),n.setInt16(68,this.intent_code,this.littleEndian),n.setInt16(70,this.datatypeCode,this.littleEndian),n.setInt16(72,this.numBitsPerVoxel,this.littleEndian),n.setInt16(74,this.slice_start,this.littleEndian);for(let o=0;o<8;o++)n.setFloat32(76+4*o,this.pixDims[o],this.littleEndian);n.setFloat32(108,this.vox_offset,this.littleEndian),n.setFloat32(112,this.scl_slope,this.littleEndian),n.setFloat32(116,this.scl_inter,this.littleEndian),n.setInt16(120,this.slice_end,this.littleEndian),n.setUint8(122,this.slice_code),n.setUint8(123,this.xyzt_units),n.setFloat32(124,this.cal_max,this.littleEndian),n.setFloat32(128,this.cal_min,this.littleEndian),n.setFloat32(132,this.slice_duration,this.littleEndian),n.setFloat32(136,this.toffset,this.littleEndian),t.set(i.encode(this.description.slice(0,80)),148),t.set(i.encode(this.aux_file.slice(0,24)),228),n.setInt16(252,this.qform_code,this.littleEndian),n.setInt16(254,this.sform_code,this.littleEndian),n.setFloat32(256,this.quatern_b,this.littleEndian),n.setFloat32(260,this.quatern_c,this.littleEndian),n.setFloat32(264,this.quatern_d,this.littleEndian),n.setFloat32(268,this.qoffset_x,this.littleEndian),n.setFloat32(272,this.qoffset_y,this.littleEndian),n.setFloat32(276,this.qoffset_z,this.littleEndian);let s=[this.srow_x,this.srow_y,this.srow_z];for(let o=0;o<3;o++)for(let d=0;d<4;d++)n.setFloat32(280+(o*4+d)*4,s[o][d],this.littleEndian);t.set(i.encode(this.intent_name.slice(0,16)),328);let r;switch(this.magic){case"ni2":r="ni1";break;case"n+2":r="n+1";break;default:r=this.magic}return t.set(i.encode(r.slice(0,3)),344),t}serializeNifti2(){let e=new TextEncoder,i=new Uint8Array(m),t=new DataView(i.buffer);t.setInt32(0,m,this.littleEndian);let n;switch(this.magic){case"ni1":n="ni2";break;case"n+1":n="n+2";break;default:n=this.magic}i.set(e.encode(n.slice(0,3)),4),t.setInt16(12,this.datatypeCode,this.littleEndian),t.setInt16(14,this.numBitsPerVoxel,this.littleEndian);for(let r=0;r<8;r++)t.setBigInt64(16+8*r,BigInt(this.dims[r]),this.littleEndian);t.setFloat64(80,this.intent_p1,this.littleEndian),t.setFloat64(88,this.intent_p2,this.littleEndian),t.setFloat64(96,this.intent_p3,this.littleEndian);for(let r=0;r<8;r++)t.setFloat64(104+8*r,this.pixDims[r],this.littleEndian);t.setBigInt64(168,BigInt(this.vox_offset),this.littleEndian),t.setFloat64(176,this.scl_slope,this.littleEndian),t.setFloat64(184,this.scl_inter,this.littleEndian),t.setFloat64(192,this.cal_max,this.littleEndian),t.setFloat64(200,this.cal_min,this.littleEndian),t.setFloat64(208,this.slice_duration,this.littleEndian),t.setFloat64(216,this.toffset,this.littleEndian),t.setBigInt64(224,BigInt(this.slice_start),this.littleEndian),t.setBigInt64(232,BigInt(this.slice_end),this.littleEndian),i.set(e.encode(this.description.slice(0,80)),240),i.set(e.encode(this.aux_file.slice(0,24)),320),t.setInt32(344,this.qform_code,this.littleEndian),t.setInt32(348,this.sform_code,this.littleEndian),t.setFloat64(352,this.quatern_b,this.littleEndian),t.setFloat64(360,this.quatern_c,this.littleEndian),t.setFloat64(368,this.quatern_d,this.littleEndian),t.setFloat64(376,this.qoffset_x,this.littleEndian),t.setFloat64(384,this.qoffset_y,this.littleEndian),t.setFloat64(392,this.qoffset_z,this.littleEndian);let s=[this.srow_x,this.srow_y,this.srow_z];for(let r=0;r<3;r++)for(let o=0;o<4;o++)t.setFloat64(400+(r*4+o)*8,s[r][o],this.littleEndian);return t.setInt32(496,this.slice_code,this.littleEndian),t.setInt32(500,this.xyzt_units,this.littleEndian),t.setInt32(504,this.intent_code,this.littleEndian),i.set(e.encode(this.intent_name.slice(0,16)),508),t.setUint8(524,this.dim_info),i.buffer}};async function P(a){let e=a.getReader(),{done:i,value:t}=await e.read();if(i)return e.releaseLock(),new ReadableStream({start(r){r.close()}});if(!t||t.length<2)return e.releaseLock(),new ReadableStream({start(r){t&&r.enqueue(t),r.close()}});let n=t[0]===31&&t[1]===139,s=new ReadableStream({async start(r){try{for(r.enqueue(t);;){let{done:o,value:d}=await e.read();if(o){r.close(),e.releaseLock();break}r.enqueue(d)}}catch(o){r.error(o),e.releaseLock()}}});return n?s.pipeThrough(new DecompressionStream("gzip")):s}var D=class{constructor(e,i){this.options=i;this.header=null;this.stopped=!1;this.buffer=new Uint8Array(0);this.bufferOffset=0;this.dataPosition=0;this.stream=e}async setup(){let e=await P(this.stream);e&&(this.stream=e),this.reader=this.stream.getReader()}async stop(){this.stopped=!0,await this.reader?.cancel()}async readBytes(e){if(!this.reader)throw new l("Reader not initialized");if(this.buffer.length-this.bufferOffset>=e){let i=this.buffer.slice(this.bufferOffset,this.bufferOffset+e);return this.bufferOffset+=e,i}if(this.buffer.length-this.bufferOffset>0){let i=this.buffer.slice(this.bufferOffset),{done:t,value:n}=await this.reader.read();if(t){if(i.length<e)throw new l(`Unexpected end of stream: needed ${e} bytes but got ${i.length}`);return i}return this.buffer=new Uint8Array(i.length+n.length),this.buffer.set(i),this.buffer.set(n,i.length),this.bufferOffset=0,this.readBytes(e)}else{let{done:i,value:t}=await this.reader.read();if(i)throw new l(`Unexpected end of stream: needed ${e} bytes but got 0`);return this.buffer=t,this.bufferOffset=0,this.readBytes(e)}}async readHeader(){let e=await this.readBytes(c),i=b.peekVersion(new DataView(e.buffer));if(!i)throw new l("Not a valid NIFTI file");if(!i.nifti1){let t=await this.readBytes(m-c),n=new Uint8Array(m);return n.set(e),n.set(t,c),b.parseNifti2(new DataView(n.buffer),i.littleEndian)}return b.parseNifti1(new DataView(e.buffer),i.littleEndian)}async readExtension(){if(!this.header||!this.reader)throw new l("Cannot read extension before header");if((await this.readBytes(4))[0]===0)return null;let i=await this.readBytes(8),t=this.header.littleEndian,n=new DataView(i.buffer),s=n.getInt32(0,t),r=n.getInt32(4,t),o=s-8,d=await this.readBytes(o);return new g({esize:s,ecode:r,edata:d.buffer,littleEndian:t})}async readNextSlice(){if(!this.header)throw new l("Cannot read slice before header");if(!this.options.sliceDimension){if(this.dataPosition===0&&this.buffer.length>this.bufferOffset){let o=this.buffer.slice(this.bufferOffset);return this.buffer=new Uint8Array(0),this.bufferOffset=0,this.dataPosition++,{data:o.buffer,indices:[]}}let{done:s,value:r}=await this.reader.read();return s?null:(this.dataPosition++,{data:r.buffer,indices:[]})}let e=this.header.dims[0],i=this.header.dims,n=this.header.numBitsPerVoxel/8;for(let s=1;s<=(this.options.sliceDimension||2);s++)i[s]>0&&(n*=i[s]);try{let s=await this.readBytes(n),r=new Array(e).fill(0);return r[this.options.sliceDimension+1]=this.dataPosition++,{data:s.buffer,indices:r}}catch(s){if(s instanceof l)return null;throw s}}async start(){if(await this.setup(),!!this.reader)try{if(this.stopped)return;if(this.header=await this.readHeader(),this.options.onHeader){if(await this.options.onHeader(this.header)){await this.stop();return}}else if(!this.options.onExtension&&!this.options.onSlice){await this.stop();return}if(!this.stopped){let e=await this.readExtension();if(this.options.onExtension){if(await this.options.onExtension(e)){await this.stop();return}}else if(!this.options.onSlice){await this.stop();return}}if(!this.options.onSlice){await this.stop();return}for(;!this.stopped;){let e=await this.readNextSlice();if(!e)break;if(await this.options.onSlice(e.data,e.indices,this.header)){await this.stop();break}}}catch(e){this.options.onError&&this.options.onError(e)}finally{this.reader.releaseLock()}}};return $(C);})();
//# sourceMappingURL=nifti-stream.js.map
